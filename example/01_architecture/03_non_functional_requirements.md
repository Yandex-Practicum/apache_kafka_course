# Погружение в нефункциональные требования

В предыдущем уроке мы затронули тему выявления функциональных и нефункциональных требований из бизнес-описания. Мы обсудили, что функциональные требования определяют, что система должна делать, а нефункциональные требования описывают, как она должна это делать.

Однако, бизнес-описание, которое мы использовали в предыдущем уроке, было довольно простым и не содержало многих важных деталей, которые могут существенно повлиять на процесс разработки и эксплуатации системы. В реальной жизни при проектировании и разработке сложных систем необходимо учитывать множество различных параметров и метрик, которые позволяют контролировать работу системы, оценивать её производительность и масштабируемость, а также прогнозировать возможные проблемы и планировать меры по их устранению.

В этом уроке мы подробнее остановимся на этих метриках, узнаем, как они вычисляются, и как можно использовать их для контроля и улучшения работы системы.

![](https://github.com/Yandex-Practicum/python_p2f_ugc/blob/6b994528efae9d328c21514503783a66305c4a33/8th-sprint-refactor/01_architecture/files/01_%D0%9F%D0%BE%D0%B3%D1%80%D1%83%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%B2%20%D0%BD%D0%B5%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%BE%D0%BD%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5%20%D1%82%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F_01.png)


## Перцентили

**Перцентиль** — это метрика, используемая в статистике, которая показывает значение, ниже которого падает определённый процент наблюдений в группе наблюдений. В контексте IT и обработки запросов к системе перцентили часто используются для измерения времени ответа системы.

- **50-й перцентиль (медиана)** — это значение, ниже которого находится 50% наблюдений. В контексте времени ответа системы это означает, что 50% запросов обрабатываются быстрее этого значения. Медиана может быть полезна для определения «типичного» времени ответа системы.
- **90-й перцентиль** — это значение, ниже которого находится 90% наблюдений. Это означает, что 90% запросов обрабатываются быстрее этого значения. 90-й перцентиль может быть полезен для понимания времени ответа системы в «худших» условиях обычной работы (то есть, исключая самые редкие и экстремальные задержки).
- **95-й перцентиль** — это значение, ниже которого находится 95% наблюдений. Это означает, что 95% запросов обрабатываются быстрее этого значения. 95-й перцентиль ещё более экстремальный и помогает понимать время ответа в самых «тяжелых» условиях обычной работы.

![](https://github.com/Yandex-Practicum/python_p2f_ugc/blob/0fa0283b61446c3655d2e96ffa991c67636c96a2/8th-sprint-refactor/01_architecture/files/%D0%9F%D0%BE%D0%B3%D1%80%D1%83%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%B2%20%D0%BD%D0%B5%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%BE%D0%BD%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5%20%D1%82%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F_02.png)


Разберём это на примере. Представьте, что у вас есть веб-сервис, который обрабатывает различные запросы от пользователей. Вы собрали статистику времени обработки запросов за один день и рассчитали следующие перцентили:

- 50-й перцентиль (медиана) составляет 200 миллисекунд: половина всех запросов обрабатывается за 200мс или быстрее.
- 90-й перцентиль составляет 400мс: 90% всех запросов обрабатываются за 400мс или быстрее.
- 95-й перцентиль составляет 600мс: 95% всех запросов обрабатываются за 600мс или быстрее.

На практике эти значения можно использовать для определения «нормального» поведения вашего сервиса и для выявления возможных проблем. Например, внезапное повышение 95-го перцентиля до нескольких секунд может указывать на проблему, которую стоит исследовать.

Кроме того, перцентили могут быть полезны при планировании изменений в системе. Если вы знаете, что ваша система может обрабатывать 95% всех запросов быстрее 600мс, вы можете использовать это значение как отправную точку при оценке влияния предлагаемых изменений на производительность.

Перцентили обычно вычисляются в рамках определённого временного интервала. Показатели, полученные за этот интервал, необязательно отражают поведение системы на протяжении всего её существования, так как она может развиваться и меняться. Но, как правило, этого достаточно, так как важно понимать текущее состояние системы, а не её прошлую историю.

Хотя перцентили могут быть полезными для понимания времени ответа системы, они не дадут полного понимания «худшего» времени ответа, так как не учитывают самые экстремальные значения.

### Квиз

Представьте, что вы работаете в компании, которая разрабатывает популярное мобильное приложение для покупки одежды. Приложение обрабатывает тысячи запросов от пользователей каждый день. Ваша задача — мониторинг производительности приложения. Вы собрали статистику времени обработки запросов за последние две недели.

После анализа данных вы выяснили, что:

- 50-й перцентиль составляет 250мс.
- 75-й перцентиль составляет 500мс.
- 90-й перцентиль составляет 850мс.
- 95-й перцентиль составляет 1000мс.

Используя эту информацию, определите, какой процент запросов обрабатывается быстрее 800мс.

- [ ] 75%
- [ ] 82% 
- [ ] 90%
- [x] Между 75% и 90%
 > Перцентили предоставляют точные значения только на определённых уровнях (например, 50%, 75%, 90%, 95%). Если вам нужно определить время отклика, которое меньше определённого значения (в данном случае 800мс), и это значение находится между двумя известными перцентилями (в данном случае между 75% (500мс) и 90% (850мс)), то точный процент не может быть определён без дополнительных данных или более подробного анализа.

## DAU/MAU

DAU и MAU — это общепринятые аббревиатуры, которые используются для отслеживания уровня активности пользователей в цифровых продуктах.

DAU означает Daily Active Users или Ежедневно активные пользователи. Это метрика, которая показывает количество уникальных пользователей, которые взаимодействуют с вашим продуктом или сервисом в течение одного дня.

MAU означает Monthly Active Users или Ежемесячно активные пользователи. Это метрика, которая показывает количество уникальных пользователей, которые взаимодействуют с вашим продуктом или сервисом в течение одного месяца.

![](https://github.com/Yandex-Practicum/python_p2f_ugc/blob/6b994528efae9d328c21514503783a66305c4a33/8th-sprint-refactor/01_architecture/files/03_%D0%9F%D0%BE%D0%B3%D1%80%D1%83%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%B2%20%D0%BD%D0%B5%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%BE%D0%BD%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5%20%D1%82%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F_03.png)


Используя эти метрики, вы можете отслеживать уровень активности и вовлечённости ваших пользователей. Снижение количеств DAU или MAU может быть сигналом о проблемах с продуктом или сервисом.

Одним из способов использования этих метрик является сравнение DAU и MAU для получения показателя stickiness или «липкости» — это показывает, как часто в среднем пользователи возвращаются к вашему продукту в течение месяца. Это вычисляется по формуле DAU / MAU и выражается в процентах. Высокий показатель «липкости» говорит о том, что пользователи регулярно возвращаются к вашему продукту или сервису.

Например, предположим, что у вас есть 1000 ежемесячно активных пользователей (MAU), и в среднем каждый день в течение этого месяца у вас было 250 ежедневно активных пользователей (DAU). В этом случае ваш показатель «липкости» будет равен 250 / 1000 = 0,25 или 25%. Это означает, что в среднем каждый из ваших пользователей взаимодействует с вашим продуктом или сервисом каждые четыре дня.


# RPS/RPM

RPS (Requests Per Second) — это количество запросов, которые сервер или система способна обрабатывать в секунду. Это важная метрика, которую часто используют при проектировании и тестировании систем с высокой нагрузкой.

Однако на практике, особенно в случае высоконагруженных систем, часто предпочитают использовать RPM (Requests Per Minute). Это связано с тем, что при мониторинге системы, особенно при высоких нагрузках, использование RPM может быть более эффективно с точки зрения экономии ресурсов средств мониторинга. RPM показывает количество запросов, которые сервер или система способна обрабатывать в минуту.

Выбор между RPS и RPM часто зависит от конкретного контекста и требований к мониторингу системы. Однако важно понимать, что обе эти метрики предоставляют важную информацию о производительности и способности системы обрабатывать входящие запросы.

![](https://github.com/Yandex-Practicum/python_p2f_ugc/blob/6b994528efae9d328c21514503783a66305c4a33/8th-sprint-refactor/01_architecture/files/04_%D0%9F%D0%BE%D0%B3%D1%80%D1%83%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%B2%20%D0%BD%D0%B5%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%BE%D0%BD%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5%20%D1%82%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F_04.png)


Понимание этих метрик и умение их вычислять помогут вам проектировать и настраивать систему так, чтобы она была способна справиться с предполагаемой нагрузкой.

Предположим, вы разрабатываете веб-приложение для заказа пиццы, и ожидаете, что в среднем у вас будет 100 000 DAU (ежедневно активных пользователей). Каждый пользователь в среднем совершает 15 действий в день (например, просмотр меню, добавление пиццы в корзину, оформление заказа), что обрабатывается как отдельный запрос к серверу. Таким образом, общее количество запросов в день будет 100 000 * 15 = 1 500 000 запросов.

Чтобы получить средний RPS, мы делим общее количество запросов на количество секунд того времени дня, когда мы ожидаем нагрузку. В нашем случае мы не ждём нагрузку ночью, поэтому будем брать 16 часов, вместо 24 (16 часов * 60 минут * 60 секунд = 57600 секунд). Таким образом, средний RPS будет равен 1 500 000 / 57 600 = ~26 RPS.

Высчитанный нами 26 RPS — это лишь среднее значение, которое может значительно отличаться от реальной картинки. Оно служит нам отправной точкой для дальнейших расчетов и планирования, но не является окончательной цифрой.

Определение реального RPS — это весьма трудоёмкий процесс, требующий знания и применения многих методик и подходов. Используются методы статистического анализа, теории массового обслуживания, машинного обучения и другие подходы для анализа и прогнозирования нагрузки.

Теперь давайте рассмотрим пиковую нагрузку. Пиковая нагрузка обычно возникает в определённые моменты времени, например во время акций, праздников или крупных событий. В самом начале, когда у вас нет достаточного количества данных для анализа, определение коэффициента пиковой нагрузки может быть сложным. В таких ситуациях, можно прогнозировать, что пиковая нагрузка будет в два-три раза больше средней. То есть 26 * 3 = 78 RPS.

Однако, это всего лишь предположение, и с течением времени, когда у вас появится больше данных, вы сможете более точно определить коэффициент пиковой нагрузки. Вы сможете анализировать исторические данные, статистику использования, учитывать сезонные колебания, особенности поведения пользователей, акции, праздники и другие события, которые могут влиять на нагрузку.

Сбор и анализ данных о нагрузке на вашу систему являются важными элементами управления производительностью. Они помогут вам не только корректно спроектировать систему с учётом пиковой нагрузки, но и прогнозировать будущую нагрузку, планировать масштабирование и оптимизацию системы, а также своевременно выявлять и устранять возможные проблемы.


### Квиз

Представьте, что вы главный архитектор в новом проекте, «Кино-палитра». Это сервис для любителей кино, где они могут создавать свои плейлисты фильмов, делиться ими и обсуждать свои предпочтения с другими пользователями. Проект амбициозен и планирует расширение на международный рынок, поэтому важно учесть мультирегиональность и мультиязычность сервиса.

Вашей команде также важно, чтобы 95-й перцентиль времени ответа сервера не превышал 200мс. Команда ожидает, что в сервисе будет около 10 000 000 активных пользователей в день (DAU). Из бизнес-модели вы знаете, что средний пользователь заходит на сервис три раза в день и в среднем выполняет 20 операций (просмотреть плейлист, добавить фильм в плейлист, поделиться плейлистом) за одну сессию.

Ваша задача — оценить среднюю и пиковую нагрузку на систему в RPS. Для расчёта пиковой нагрузки используйте правило «80/20» или [Закон Паре́то](https://ru.wikipedia.org/wiki/%D0%97%D0%B0%D0%BA%D0%BE%D0%BD_%D0%9F%D0%B0%D1%80%D0%B5%D1%82%D0%BE){target="_blank"}, согласно которому 80% трафика приходится на 20% времени. И обратите внимание на тот факт, что проект международный, а значит, нагрузка будет круглосуточная.

- [ ] Средний RPS: 5200, Пиковый RPS: 26000.
- [x] Средний RPS: 6944, Пиковый RPS: 34 722.
 > Для начала мы рассчитаем общее количество операций в день: DAU * количество сессий * количество операций = 10 000 000 * 3 * 20 = 600 000 000 операций в день.
>
 > Затем, чтобы получить средний RPS, мы разделим общее количество операций на количество секунд в сутках (24 * 60 * 60 = 86400 секунд): 600 000 000 / 86400 = 6944.44 RPS.
> 
 > Для расчета пиковой нагрузки мы используем правило 80/20, согласно которому 80% трафика приходится на 20% времени. То есть, пиковая нагрузка будет в 5 раз выше средней: 6944 * 5 = 34 722 RPS.
- [ ] Средний RPS: 10 325, Пиковый RPS: 51625
- [ ] Средний RPS: 1250, Пиковый RPS: 6250

